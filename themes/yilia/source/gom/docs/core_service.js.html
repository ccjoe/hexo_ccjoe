<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/service.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">首页 Home</a></h2><h3>类Classes</h3><ul><li><a href="Gom.html">Gom</a><ul class='methods'><li data-type='method'><a href="Gom.html#.Utils">Utils</a></li></ul></li><li><a href="Gom.App.html">App</a><ul class='methods'><li data-type='method'><a href="Gom.App.html#getCRO">getCRO</a></li><li data-type='method'><a href="Gom.App.html#getLastHashByLastIndex">getLastHashByLastIndex</a></li><li data-type='method'><a href="Gom.App.html#goto">goto</a></li><li data-type='method'><a href="Gom.App.html#run">run</a></li><li data-type='method'><a href="Gom.App.html#setCRO">setCRO</a></li></ul></li><li><a href="Gom.Page.html">Page</a><ul class='methods'><li data-type='method'><a href="Gom.Page.html#destory">destory</a></li><li data-type='method'><a href="Gom.Page.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.Page.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.Page.html#offview">offview</a></li><li data-type='method'><a href="Gom.Page.html#onview">onview</a></li><li data-type='method'><a href="Gom.Page.html#push">push</a></li><li data-type='method'><a href="Gom.Page.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.Page.html#render">render</a></li><li data-type='method'><a href="Gom.Page.html#setHeader">setHeader</a></li><li data-type='method'><a href="Gom.Page.html#setSeo">setSeo</a></li><li data-type='method'><a href="Gom.Page.html#show">show</a></li><li data-type='method'><a href="Gom.Page.html#update">update</a></li></ul></li><li><a href="Gom.Service.html">Service</a><ul class='methods'><li data-type='method'><a href="Gom.Service.html#ajax">ajax</a></li><li data-type='method'><a href="Gom.Service.html#fetch">fetch</a></li><li data-type='method'><a href="Gom.Service.html#get">get</a></li><li data-type='method'><a href="Gom.Service.html#jsonp">jsonp</a></li><li data-type='method'><a href="Gom.Service.html#post">post</a></li><li data-type='method'><a href="Gom.Service.html#save">save</a></li><li data-type='method'><a href="Gom.Service.html#tmpl">tmpl</a></li></ul></li><li><a href="Gom.UI.html">UI</a></li><li><a href="Gom.UI.Button.html">Button</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Button.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Button.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Button.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Button.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Button.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Button.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Button.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Button.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Button.html#update">update</a></li></ul></li><li><a href="Gom.UI.Form.html">Form</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Form.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Form.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Form.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Form.html#getStore">getStore</a></li><li data-type='method'><a href="Gom.UI.Form.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Form.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Form.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Form.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Form.html#setStore">setStore</a></li><li data-type='method'><a href="Gom.UI.Form.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Form.html#update">update</a></li></ul></li><li><a href="Gom.UI.Header.html">Header</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Header.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Header.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Header.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Header.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Header.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Header.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Header.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Header.html#setTitle">setTitle</a></li><li data-type='method'><a href="Gom.UI.Header.html#setTitle">setTitle</a></li><li data-type='method'><a href="Gom.UI.Header.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Header.html#update">update</a></li></ul></li><li><a href="Gom.UI.InputLocation.html">InputLocation</a><ul class='methods'><li data-type='method'><a href="Gom.UI.InputLocation.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#render">render</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#show">show</a></li><li data-type='method'><a href="Gom.UI.InputLocation.html#update">update</a></li></ul></li><li><a href="Gom.UI.List.html">List</a><ul class='methods'><li data-type='method'><a href="Gom.UI.List.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.List.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.List.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.List.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.List.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.List.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.List.html#render">render</a></li><li data-type='method'><a href="Gom.UI.List.html#show">show</a></li><li data-type='method'><a href="Gom.UI.List.html#update">update</a></li></ul></li><li><a href="Gom.UI.Modal.html">Modal</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Modal.html#.alert">alert</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.bottom">bottom</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.bottom">bottom</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.center">center</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.confirm">confirm</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.layout">layout</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.loading">loading</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.popover">popover</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.tips">tips</a></li><li data-type='method'><a href="Gom.UI.Modal.html#.top">top</a></li><li data-type='method'><a href="Gom.UI.Modal.html#autoHide">autoHide</a></li><li data-type='method'><a href="Gom.UI.Modal.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Modal.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Modal.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Modal.html#getMask">getMask</a></li><li data-type='method'><a href="Gom.UI.Modal.html#getModal">getModal</a></li><li data-type='method'><a href="Gom.UI.Modal.html#getType">getType</a></li><li data-type='method'><a href="Gom.UI.Modal.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Modal.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Modal.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Modal.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Modal.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Modal.html#toggleModal">toggleModal</a></li><li data-type='method'><a href="Gom.UI.Modal.html#update">update</a></li></ul></li><li><a href="Gom.UI.Radio.html">Radio</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Radio.html#fresh">fresh</a></li><li data-type='method'><a href="Gom.UI.Radio.html#fresh">fresh</a></li><li data-type='method'><a href="Gom.UI.Radio.html#fresh">fresh</a></li><li data-type='method'><a href="Gom.UI.Radio.html#getItem">getItem</a></li><li data-type='method'><a href="Gom.UI.Radio.html#getItem">getItem</a></li></ul></li><li><a href="Gom.UI.Scroll.html">Scroll</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Scroll.html#getSteps">getSteps</a></li><li data-type='method'><a href="Gom.UI.Scroll.html#hideFresh">hideFresh</a></li><li data-type='method'><a href="Gom.UI.Scroll.html#scrollTo">scrollTo</a></li><li data-type='method'><a href="Gom.UI.Scroll.html#showFresh">showFresh</a></li></ul></li><li><a href="Gom.UI.Select.html">Select</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Select.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Select.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Select.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Select.html#getSelect">getSelect</a></li><li data-type='method'><a href="Gom.UI.Select.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Select.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Select.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Select.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Select.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Select.html#update">update</a></li></ul></li><li><a href="Gom.UI.Sides.html">Sides</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Sides.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Sides.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Sides.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Sides.html#getSides">getSides</a></li><li data-type='method'><a href="Gom.UI.Sides.html#hide">hide</a></li><li data-type='method'><a href="Gom.UI.Sides.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Sides.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Sides.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Sides.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Sides.html#setContent">setContent</a></li><li data-type='method'><a href="Gom.UI.Sides.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Sides.html#update">update</a></li></ul></li><li><a href="Gom.UI.Slide.html">Slide</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Slide.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Slide.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Slide.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Slide.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Slide.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Slide.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Slide.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Slide.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Slide.html#update">update</a></li></ul></li><li><a href="Gom.UI.Toggle.html">Toggle</a><ul class='methods'><li data-type='method'><a href="Gom.UI.Toggle.html#destory">destory</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#offview">offview</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#onview">onview</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#render">render</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#show">show</a></li><li data-type='method'><a href="Gom.UI.Toggle.html#update">update</a></li></ul></li><li><a href="Gom.View.html">View</a><ul class='methods'><li data-type='method'><a href="Gom.View.html#.template">template</a></li><li data-type='method'><a href="Gom.View.html#destory">destory</a></li><li data-type='method'><a href="Gom.View.html#getHTMLFragment">getHTMLFragment</a></li><li data-type='method'><a href="Gom.View.html#getHTMLTmpl">getHTMLTmpl</a></li><li data-type='method'><a href="Gom.View.html#offview">offview</a></li><li data-type='method'><a href="Gom.View.html#onview">onview</a></li><li data-type='method'><a href="Gom.View.html#refreshEvent">refreshEvent</a></li><li data-type='method'><a href="Gom.View.html#render">render</a></li><li data-type='method'><a href="Gom.View.html#show">show</a></li><li data-type='method'><a href="Gom.View.html#update">update</a></li></ul></li></ul><h3>命名空间 Namespaces</h3><ul><li><a href="store.html">store</a><ul class='methods'><li data-type='method'><a href="store.html#.del">del</a></li><li data-type='method'><a href="store.html#.del">del</a></li><li data-type='method'><a href="store.html#.each">each</a></li><li data-type='method'><a href="store.html#.get">get</a></li><li data-type='method'><a href="store.html#.has">has</a></li><li data-type='method'><a href="store.html#.noexpire">noexpire</a></li><li data-type='method'><a href="store.html#.size">size</a></li></ul></li><li><a href="url.html">url</a><ul class='methods'><li data-type='method'><a href="url.html#.getHashPath">getHashPath</a></li><li data-type='method'><a href="url.html#.getHashSearch">getHashSearch</a></li><li data-type='method'><a href="url.html#.getHTML5Hash">getHTML5Hash</a></li><li data-type='method'><a href="url.html#.getParams">getParams</a></li><li data-type='method'><a href="url.html#.getUrl">getUrl</a></li><li data-type='method'><a href="url.html#.set">set</a></li><li data-type='method'><a href="url.html#.setParam">setParam</a></li></ul></li></ul><h3>Global 全局</h3><ul><li><a href="global.html#easingMap">easingMap</a></li><li><a href="global.html#re">re</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html#swipe">swipe</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">core/service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {Modals} from '../ui/ui.modal';
var loading;
//要达到的设定有：
//支持实际场景不跨域开发跨域时的配置 devCrossDomain: true(CROS)
//支持 jsonp与ajax的一键切换开发模式，当模式变化时，前端可以快速反应
//支持 header, data, cookie相关数据传输
//支持 ajax injector， 在ajax request与response处可以统一处理。

//默认Ajax截击器
var defaultInject = {
    request: function(e, xhr, options){
        //console.log(e, xhr, options, 'default request inject');
    },
    response: function(e, xhr, options){
        //console.log(e, xhr, options, 'default response inject');
    }
};

//从外部自定义Ajax截击器
var modelInject = $.extend({}, defaultInject);
//如果有外部Ajax截击器则均触发，否则仅触发默认;
var inject = function(req, res){
    modelInject.request = function(e, xhr, options){
        defaultInject.request(e, xhr, options);
        var defreq = req(e, xhr, options);
        if(defreq === false) return false;   //自定义的req return false时阻止ajax请求
    };

    modelInject.response = function(e, xhr, options){
        defaultInject.response(e, xhr, options);
        res(e, xhr, options);
    };
};

//全局处理
$.ajaxSettings.timeout = 1000 * 60; //默认超时时间为1分钟
$.ajaxSettings.error = function(xhr, errorType) {
    if (errorType === 'timeout') {
        Modals.toast('信号偏弱，访问超时', 'error');
    } else if (errorType === 'error') {
        var statusCode = xhr.status;
        Modals.toast('请求发生错误,状态码:' +statusCode, 'error');
        if (statusCode === 404 || statusCode === 500) {   //处理状态码错误
            //window.location.href = '?' + statusCode;
        }
    }
};

$(document).on('ajaxBeforeSend', function(e, xhr, options){
    loading = Modals.loading(false).render();
    var req = modelInject.request(e, xhr, options);
    if(req === false) return false;  //阻击发出请求
}).on('ajaxComplete', function(e, xhr, options){
    loading.remove();
    modelInject.response(e, xhr, options);
});

/**
 * Model分构造函数与方式调用二种调用，
 * 其用处为构造函数时用于构造Modal的ajax封装，用法为 new Model({url: '//example.com/getList?id=123'});
 * 为方式时作为ajax拦截注入器注入request与response, 用法为 new Model({req:function(){}, res: function(){}});
 * @class Gom.Service
 * @alias Service
 * @param {object} opts A:参列 或 B:opts.req, opts.res
 * @param {string} opts.url A时的属性
 * @param {object} opts.param A时的属性 默认参数
 * @param {object} opts.req B时的属性 对所有请求截击
 * @param {object} opts.res B时的属性 对所有返回截击
 * @examle B: Service ajax注入器操作，对request,response统一处理。
    new Service({
        req:function(e, xhr, options){
            console.log(e, xhr, options, 'def request inject');
            if(!!~options.url.indexOf('http://www.test.me:3003')) return false;   //return false时拦截ajax发出请求发现
        },
        res: function(e, xhr, options){
            console.log(e, xhr, options, 'def response inject');
        }
    });
    //A:Service ajax操作
    var listModel = new Service({
        url: 'http://www.test.me:3003/api/mall/receipts'
    });
    listModel.fetch({userId:123}).done(function(data){
        console.log(data, 'data');
    });
 *
 *
 *
 *
 */
class Service {
    constructor (opts) {
        //如果为注入器，仅执行注入操作，不实例化Service;
        if(opts.req || opts.res){
            inject(opts.req, opts.res);
            return;
        }
        this.url = opts.url;
        this.params = opts.params || {};
        /**
         *@method Gom.Service#get
         * @see  http://zeptojs.com/#$.get
         */
        this.get = $.get;
        /**
         * @method Gom.Service#post
         * @see  http://zeptojs.com/#$.post
         */
        this.post = $.post;
    }
    /**
     * 一般用于post保存数据
     * @method Gom.Service#save
     * @param {object} params 保存的数据
     * @return promise
     */
    save (params){
        return this.ajax($.extend({}, this.params, params), {type: 'POST'});
    }
    /**
     * 一般用于get获取数据
     * @method Gom.Service#fetch
     * @param {object|*} ids id集合或id等
     * @return promise
     */
    fetch (ids){
        return this.ajax($.extend({}, this.params, ids));
    }
    /**
     * 获取jsonp数据
     * @method Gom.Service#jsonp
     * @param {object|*} params集合
     * @return promise
     */
    jsonp (params){
        return this.ajax($.extend({}, this.params, params), {dataType: 'jsonp', type : 'GET'});
    }
    /**
     * 同步获取本地模板
     * @method Gom.Service#tmpl
     */
    tmpl (){
        return this.ajax({dataType:'html', async: false})
    }

    /**
     * @method Gom.Service#ajax
     * @param {object} data
     * @param {object} opts
     * @returns {promise}
     * @see  http://zeptojs.com/#ajax 参见zepto的ajax里的data与opts
     */
    ajax (data, opts){
        var ajaxOpts = {}, opts = opts || {};
        if(opts.withCredentials){
            ajaxOpts.xhrFields = {
                withCredentials: true
            };
        }
        $.extend(ajaxOpts, opts,  {
            url: this.url,
            data: $.extend({}, this.params, data),
            dataType: opts.dataType || 'json', //json, jsonp, script, xml, html, or text.
            //headers: opts.headers || {}, //自定义请求会触发预请求
            //async: opts.async || true,    //默认异步
            //crossDomain: true,
            //timeout: 300,
        });

        return $.ajax(ajaxOpts);
    }
}

export default Service;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.0-dev</a> on Sun Jan 17 2016 16:54:24 GMT+0800 (CST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
